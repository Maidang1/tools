# 实现计划

- [x] 1. 创建新的 UI 模块结构
  - 创建 `src/ui/layout.rs` 模块用于布局计算
  - 创建 `src/ui/widgets.rs` 模块用于自定义 widget
  - 创建 `src/ui/theme.rs` 模块用于主题和样式
  - 在 `src/ui/mod.rs` 中导出新模块
  - _需求: 1.1, 1.2, 1.3_

- [x] 2. 实现主题系统
  - 在 `theme.rs` 中定义 `Theme` 结构体，包含颜色配置
  - 实现 `Theme::default()` 方法，提供默认配色方案
  - 实现样式辅助方法（`style_title`、`style_text`、`style_highlight` 等）
  - _需求: 9.1, 9.2_

- [x] 3. 实现布局管理器
  - 在 `layout.rs` 中定义 `AppLayout` 结构体，存储各区域的 `Rect`
  - 实现 `LayoutManager` 结构体和 `new()` 方法
  - 实现 `calculate_layout()` 方法，计算三层垂直布局
  - 实现 `is_compact_mode()` 方法，判断是否需要紧凑模式（宽度 < 80）
  - 在 `calculate_layout()` 中实现响应式逻辑：宽度 >= 80 时水平分割中部区域
  - _需求: 1.1, 1.3, 4.1, 4.4, 8.1_

- [x] 3.1 编写属性测试：布局三区域结构
  - **属性 1: 布局三区域结构**
  - **验证: 需求 1.1, 1.3**

- [x] 3.2 编写属性测试：中部区域水平分割
  - **属性 7: 中部区域水平分割**
  - **验证: 需求 4.1**

- [x] 3.3 编写属性测试：曲目列表宽度比例
  - **属性 8: 曲目列表宽度比例**
  - **验证: 需求 4.2**

- [x] 3.4 编写属性测试：可视化区宽度比例
  - **属性 9: 可视化区宽度比例**
  - **验证: 需求 4.3**

- [x] 3.5 编写属性测试：小高度终端布局适配
  - **属性 15: 小高度终端布局适配**
  - **验证: 需求 8.2**

- [x] 4. 实现 NowPlayingWidget
  - 在 `widgets.rs` 中定义 `NowPlayingWidget` 结构体
  - 实现 `Widget` trait 的 `render` 方法
  - 渲染曲目标题、播放状态图标
  - 处理无曲目播放的情况，显示欢迎信息
  - _需求: 2.1, 2.3, 2.4_

- [x] 4.1 编写属性测试：当前播放信息包含曲目标题
  - **属性 2: 当前播放信息包含曲目标题**
  - **验证: 需求 2.1**

- [x] 4.2 编写属性测试：播放状态图标显示
  - **属性 3: 播放状态图标显示**
  - **验证: 需求 2.4**

- [x] 4.3 编写单元测试：无曲目播放显示欢迎信息
  - 测试当 `track` 为 `None` 时显示欢迎信息
  - _需求: 2.3_

- [x] 5. 实现 PlaybackControlWidget
  - 在 `widgets.rs` 中定义 `PlaybackControlWidget` 结构体
  - 实现进度条渲染，使用 `Gauge` widget
  - 实现时间显示（当前时间/总时长），格式化为 MM:SS
  - 实现音量指示器显示
  - 添加播放控制提示文本
  - _需求: 3.1, 3.2, 3.3, 3.4_

- [x] 5.1 编写属性测试：进度条占据全宽
  - **属性 4: 进度条占据全宽**
  - **验证: 需求 3.1**

- [x] 5.2 编写属性测试：时间信息显示
  - **属性 5: 时间信息显示**
  - **验证: 需求 3.2**

- [x] 5.3 编写属性测试：音量指示器显示
  - **属性 6: 音量指示器显示**
  - **验证: 需求 3.3**

- [x] 6. 实现 TrackListWidget
  - 在 `widgets.rs` 中定义 `TrackListWidget` 结构体
  - 使用 ratatui 的 `List` widget 渲染曲目列表
  - 为每个曲目添加序号、播放图标（如果正在播放）、曲目名称
  - 处理空列表情况，显示"未找到音频文件"
  - 应用高亮样式到选中的曲目
  - _需求: 5.1, 5.2, 5.3, 5.5_

- [x] 6.1 编写属性测试：曲目列表包含所有曲目
  - **属性 10: 曲目列表包含所有曲目**
  - **验证: 需求 5.1**

- [x] 6.2 编写属性测试：播放图标标记
  - **属性 11: 播放图标标记**
  - **验证: 需求 5.2**

- [x] 6.3 编写单元测试：空列表显示提示
  - 测试当曲目列表为空时显示提示信息
  - _需求: 5.5_

- [x] 7. 实现 VisualizationWidget
  - 在 `widgets.rs` 中定义 `VisualizationWidget` 结构体
  - 使用 ratatui 的 `Sparkline` widget 渲染波形
  - 根据播放状态调整可视化效果（播放时动态，停止时静态）
  - 应用颜色渐变样式
  - _需求: 6.1, 6.3_

- [x] 7.1 编写属性测试：可视化渲染成功
  - **属性 12: 可视化渲染成功**
  - **验证: 需求 6.1**

- [x] 7.2 编写属性测试：停止状态可视化静态
  - **属性 13: 停止状态可视化静态**
  - **验证: 需求 6.3**

- [x] 8. 实现 StatusBarWidget
  - 在 `widgets.rs` 中定义 `StatusBarWidget` 结构体
  - 渲染快捷键提示信息
  - 使用简洁的格式显示（如 "q:退出 ↑/↓:导航 Enter:播放"）
  - _需求: 7.1, 7.2_

- [x] 8.1 编写属性测试：状态栏位于底部
  - **属性 14: 状态栏位于底部**
  - **验证: 需求 7.1**

- [x] 8.2 编写单元测试：快捷键提示显示
  - 测试状态栏包含所有必要的快捷键提示
  - _需求: 7.2_

- [x] 9. 更新 App 结构
  - 在 `main.rs` 的 `App` 结构体中添加 `theme: Theme` 字段
  - 在 `App::new()` 中初始化主题为默认主题
  - 添加 `compact_mode: bool` 字段（可选，用于缓存模式状态）
  - _需求: 所有需求_
- [x] 10. 重构主渲染逻辑
  - 在 `main.rs` 的渲染循环中，使用 `LayoutManager` 计算布局
  - 使用新的 widget 替换旧的渲染代码
  - 渲染 `NowPlayingWidget` 到顶部区域
  - 渲染 `TrackListWidget` 到中部左侧区域
  - 渲染 `VisualizationWidget` 到中部右侧区域（如果非紧凑模式）
  - 渲染 `PlaybackControlWidget` 到底部播放控制区
  - 渲染 `StatusBarWidget` 到最底部状态栏
  - _需求: 所有需求_

- [x] 10.1 编写集成测试：完整界面渲染
  - 测试从 App 状态到完整界面渲染的流程
  - 验证所有区域都正确渲染

- [x] 11. 测试和调试
  - 在不同终端尺寸下测试布局
  - 测试紧凑模式切换
  - 测试所有播放状态下的界面显示
  - 测试边界情况（空列表、极小终端等）
  - 修复发现的问题
  - _需求: 所有需求_

- [x] 12. 清理和优化
  - 移除旧的渲染代码（如果有遗留）
  - 添加代码文档注释
  - 优化性能（如布局缓存）
  - 确保代码符合 Rust 最佳实践
  - _需求: 所有需求_
